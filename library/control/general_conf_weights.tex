\documentclass[10pt,tikz]{standalone}

\ifstandalone%
\usepackage{import}%
\import{../../configuration/}{comon_packages.tex}%
\import{../../configuration/}{variables.tex}%
\import{../../configuration/}{conftikz.tex}%
\import{../../configuration/}{custom_config.tex}%
\fi

\begin{document}
\begin{tikzpicture}
  % Parameters
  \def\spacing{1}
  \def\blockw{1.2cm}
  \def\blockh{1.0cm}
  \def\addsize{0.7cm}

  % Blocs
  \node[draw, block] (G) {$G$};

  \node[draw, add, minimum size=\addsize, right=\spacing of G] (addy) {};
  \node[draw, block, above=0.5*\spacing of addy] (Gd) {$G_d$};

  \node[draw, block, above=2.0*\spacing of G] (Wd) {$W_d$};
  \node[draw, block, above=0.5*\spacing of Wd] (Wn) {$W_n$};

  \node[draw, add, minimum size=\addsize, right=\spacing of addy] (addn) {};

  \node[draw, block, above right=1.5*\spacing and 0.2*\spacing of addn] (Wu) {${W_u}^{-1}$};
  \node[draw, block, above=0.5*\spacing of Wu] (We) {${W_e}^{-1}$};

  % Inputs
  \coordinate[left=1.2*\spacing of Wd] (d);
  \coordinate[left=1.2*\spacing of Wn] (n);

  % Outputs
  \coordinate[right=1.2*\spacing of We] (y);
  \coordinate[right=1.2*\spacing of Wu] (F);

  \coordinate (u) at (n|-G);
  \coordinate (v) at (F|-G);

  \node[fit={($(n) + (0, 0.5*\blockh) + (0.5*\spacing, 0.2*\spacing)$) ($(v|-G.south) - (0.5*\spacing, 0.2*\spacing)$)}, inner sep=0pt, draw, dashed, color=gray, label={Generalized Weighted Plant $P$}] (P) {};

  \node[draw, block, below=\spacing of P] (K) {$K$};


  % Connections
  \draw[->] (G.east) -- (addy.west);
  \draw[->] (addy.east) -- (addn.west);
  \draw[->] (Gd.south) -- (addy.north);
  \draw[<-] (addn.north) -- ++(0, 0.5*\spacing);

  \draw[->] (d) -- (Wd.west);
  \draw[->] (Wd.east) node[above right]{$\tilde{d}$} -| (Gd.north);
  \draw[->] (n) -- (Wn.west);
  \draw[->] (Wn.east) node[above right]{$\tilde{n}$} -| (addn.north);

  \draw[->] ($(addn.west) + (-0.4*\spacing, 0)$) |- (We.west) node[above left]{$\tilde{y}$};
  \draw[->] ($(G.west)    + (-0.4*\spacing, 0)$) |- (Wu.west) node[above left]{$\tilde{u}$};
  \draw[->] (We.east) -- (y);
  \draw[->] (Wu) -- (F);

  \draw[->] (addn.east) -- (v) |- (K.east);
  \draw[->] (K.west) -| (u) -- (G.west);

  % Labels
  \node[above right] (un) at (u) {$u$};
  \node[above left] (vn) at (v) {$v$};
  \node[above right] (dn) at (d) {$d$};
  \node[above right] (nn) at (n) {$n$};
  \node[above left] (yn) at (y) {$y$};
  \node[above left] (Fn) at (F) {$u$};

  % W and Z brackets
  \draw [decoration={brace, raise=7pt}, decorate] (dn.south west) -- node[left=8pt]{$w$} (nn.north west);
  \draw [decoration={brace, raise=5pt}, decorate] (yn.north east) -- node[right=6pt]{$z$} (Fn.south east);
\end{tikzpicture}
\end{document}
